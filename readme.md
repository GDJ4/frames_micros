# Отчёт по заданию «Микросервисная структура по управлению задачами» – ООО «СистемаКонтроля»

## 1. Анализ и постановка задачи
В стартовом репозитории были три простых Node.js приложения (`api_gateway`, `service_users`, `service_orders`) с in-memory данными. Требовалось привести систему к единому стандарту качества: единый формат ответов, JWT-аутентификация, проверка прав, логирование и трассировка, ограничение запросов, подготовка спецификации и тестов, работа в трёх окружениях (dev/test/prod).

**Цель:** собрать рабочий бэкенд на микросервисной архитектуре с API-шлюзом, сервисом пользователей и сервисом заказов, повысить надёжность и наблюдаемость, оформить документацию и тестовое покрытие.

## 2. Разработка и реализация
1. **Переписано на Go:** три независимых сервиса (gateway, users, orders) с префиксом `/v1`, единый ответ `{success, data|error}`, версии в путях.
2. **Аутентификация и роли:** HS256 JWT, регистрация/логин, профиль, список пользователей (только admin) с фильтрами и пагинацией, строгая проверка прав (доступ к своим данным, админские функции отдельно).
3. **API Gateway:** проксирует `/v1/users/**` и `/v1/orders/**`, проверяет JWT, добавляет и прокидывает `X-Request-ID`, `X-User-*`, применяет rate limiting (token bucket), CORS, логи с меткой запроса.
4. **Сервис заказов:** создание, получение, список с сортировкой/пагинацией, обновление статуса, отмена, контроль валидных переходов и прав (владелец или admin), внутренняя проверка существования пользователя через `X-Service-Key`, доменные события (`order.created`, `order.status_updated`, `order.cancelled`) с выдачей последних событий для admin.
5. **Наблюдаемость и надёжность:** health/status эндпоинты во всех сервисах, структурные логи с `req_id`, CORS, timeouts, recovery middleware, конфигурация через env для dev/test/prod, Dockerfile и docker-compose для сборки/запуска.
6. **Документация:** OpenAPI 3.0 (`docs/openapi.yaml`) для публичных путей через gateway, инструкция по ручным тестам (`test.md`), описания переменных окружения.

## 3. Архитектура и данные
- **Формат ответов:** `success` + `data` или `error {code, message}`; авторизация через `Authorization: Bearer <token>`.
- **Пользователь:** `id (uuid)`, `email`, `name`, `roles[]`, даты создания/обновления; пароли хранятся как salt+SHA-256.
- **Заказ:** `id (uuid)`, `userId`, `items {product, quantity, price}`, `status (created|in_progress|done|cancelled)`, `total`, даты.
- **События:** хранятся в памяти, доступны по `/v1/orders/events` (только admin), макс. 200 последних.

## 4. Тестирование и документация
- **Ручные тесты (curl):** файл `test.md` — регистрация, дубликат, логин, 401 без токена, профиль, создание заказа, список, получение по ID, отмена, отказ на изменение чужого заказа.
- **Юнит-тесты:** `service_users/main_test.go`, `service_orders/main_test.go` (запуск: `GOCACHE=./.gocache go test ./...` в соответствующей папке).
- **Спецификация:** `docs/openapi.yaml` описывает основные публичные эндпоинты gateway.

## 5. Результаты тестирования (ожидаемые статусы)
1. Регистрация пользователя — `201 Created`, возвращён токен.
2. Повторная регистрация — `409 Conflict`.
3. Вход — `200 OK`, JWT получен.
4. Доступ к `/v1/users/me` без токена — `401 Unauthorized`.
5. Профиль с токеном — `200 OK`.
6. Создание заказа — `201 Created`, статус `created`.
7. Список своих заказов — `200 OK`, заказ виден.
8. Получение заказа по ID — `200 OK`.
9. Отмена своего заказа — `200 OK`, статус `cancelled`.
10. Попытка изменить чужой заказ — `403 Forbidden`.

## 6. Запуск и окружения
```bash
cd micro-task-template
docker compose --env-file env/dev.env up --build
```
Порты: gateway `8000`, users `9001`, orders `9002`. Ключевые переменные: `JWT_SECRET`, `INTERNAL_API_KEY`, `USERS_SERVICE_URL`, `ORDERS_SERVICE_URL`, `RATE_LIMIT_RPS`, `RATE_LIMIT_BURST`, `APP_ENV`.
