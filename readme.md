# Отчёт по заданию микросервисная структура по управлению задачами – ООО «СистемаКонтроля» по работе с строительными объектами
### Лазарев Г.С. ЭФБО-10-23


## 1. Анализ и постановка задачи

Исходный репозиторий содержал три независимых Node.js приложения (`api_gateway`, `service_users`, `service_orders`), которые поднимались через `docker-compose`, но работали разрозненно: данные только в памяти, формат ответов различался, аутентификация отсутствовала, логирование и трассировка не унифицированы, защиты от нагрузки не было. Не хватало документации и тестовых сценариев для ручной проверки.

**Цель работы:** собрать рабочий бэкенд с тремя сервисами и API-шлюзом, привести их к единому стандарту качества кода, добавить аутентификацию/авторизацию, наблюдаемость, защиту от перегрузки и оформить полную документацию с тестовыми сценариями для dev/test/prod окружений.

## 2. Разработка и реализация

1. **Переписано на Go, единый контракт API:** все сервисы переведены на Go с префиксом `/v1`, ответы приведены к формату `{success, data|error}`, версии вынесены в путь.
2. **JWT-аутентификация и роли:** HS256, эндпоинты регистрации/логина, профиль, админский список пользователей с фильтрами и пагинацией. Проверка прав по ролям и владельцу ресурса.
3. **API Gateway:** проксирует `/v1/users/**` и `/v1/orders/**`, валидирует JWT, добавляет `X-Request-ID`, `X-User-*`, применяет rate limiting (token bucket), CORS и структурные логи для трассировки.
4. **Сервис заказов:** создание, получение, список с сортировкой/пагинацией, обновление статуса и отмена с контролем валидных переходов и прав (владелец или admin). Проверка существования пользователя через внутренний вызов (`/v1/internal/users/{id}`) и `X-Service-Key`. Поддержка доменных событий (`order.created`, `order.status_updated`, `order.cancelled`) с выдачей последних 200 событий для admin.
5. **Наблюдаемость и надёжность:** health/status эндпоинты во всех сервисах, middleware для recovery и таймаутов, единый формат логов с `req_id`. Ограничение нагрузки в шлюзе, CORS включён для удобства ручных проверок.
6. **Окружения и инфраструктура:** env-файлы для dev/test/prod, `docker-compose.yml` для быстрого запуска трёх сервисов. Конфигурация через переменные (`JWT_SECRET`, `INTERNAL_API_KEY`, `USERS_SERVICE_URL`, `ORDERS_SERVICE_URL`, `RATE_LIMIT_*`, `APP_ENV`).

## 3. Тестирование и документация

* **Спецификация API:** `docs/openapi.yaml` описывает публичные маршруты через gateway.
* **Ручное тестирование:** `test.md` содержит пошаговые `curl`-команды (регистрация, дубликат, логин, 401 без токена, профиль, создание/получение/отмена заказа, попытка изменения чужим пользователем). Для быстрой проверки есть скрипт `bash.sh`, который автоматически регистрирует, логинит и создаёт заказ.
* **Юнит-тесты сервисов:** `service_users/main_test.go`, `service_orders/main_test.go`. Запуск из корня:
  ```bash
  cd service_users && GOCACHE=$(pwd)/.gocache go test ./...
  cd service_orders && GOCACHE=$(pwd)/.gocache go test ./...
  ```
* **Инфраструктура и запуск:** `docker-compose.yml` и `env/*.env` позволяют поднять систему командой:
  ```bash
  docker compose --env-file env/dev.env up --build
  ```
  Порты: gateway `8000`, users `9001`, orders `9002`.

## 4. Результаты тестирования

Фактически проведённые ручные сценарии (статусы и ожидания):

1. **Регистрация пользователя** — `201 Created`, возвращён токен, пользователь создан.
2. **Повторная регистрация** — `409 Conflict`, защита от дублирования email.
3. **Вход пользователя (логин)** — `200 OK`, JWT получен и дальше используется в авторизации.
4. **Доступ к защищенному маршруту без токена** — `401 Unauthorized`, проверка обязательности заголовка.
5. **Доступ к профилю с токеном** — `200 OK`, возвращаются данные профиля.
6. **Создание заказа** — `201 Created`, заказ в статусе `created`, рассчитана сумма.
7. **Получение списка заказов** — `200 OK`, виден созданный заказ (фильтр по владельцу).
8. **Получение заказа по ID** — `200 OK`, возвращены данные конкретного заказа.
9. **Отмена собственного заказа** — `200 OK`, статус `cancelled`.
10. **Попытка изменить чужой заказ** — `403 Forbidden`, отказ из-за отсутствия прав.

Скриншоты результатов (из ручных тестов):

![Результат регистрации](assets/test_screenshots/1.png)
![Результат повторной регистрации](assets/test_screenshots/2.png)
![Результат входа](assets/test_screenshots/3.png)
![Результат без токена](assets/test_screenshots/4.png)
![Результат с токеном](assets/test_screenshots/5.png)
![Результат создания заказа](assets/test_screenshots/6.png)
![Результат получения списка заказов](assets/test_screenshots/7.png)
![Результат получения заказа по ID](assets/test_screenshots/8.png)

---

# Отчёт по заданию микросервисная структура по управлению задачами – ООО «СистемаКонтроля» по работе с строительными объектами
### Ефремов Алексей Игоревич ЭФБО-10-23

## 1. Анализ и постановка задачи

Начальный проект состоял из трёх отдельных Node.js приложений (`api_gateway`, `service_users`, `service_orders`), запускаемых через `docker-compose`. Приложения имели базовую функциональность, но не соответствовали требованиям безопасности, надёжности и удобства поддержки.

**Цель работы:** Цель разработки — собрать рабочий бэкенд с тремя компонентами, привести микросервисы и API-шлюз к единому стандарту качества кода, повысить надежность, наблюдаемость и безопасность.

## 2. Разработка и реализация

1.  **Реализована JWT-аутентификация:** В `service_users` добавлены эндпоинты `/users/register` и `/users/login`. Пароли хешируются, при успешном входе выдается JWT.
2.  **Внедрен Middleware в API Gateway:** Шлюз теперь проверяет JWT для всех защищенных маршрутов и передает ID пользователя в заголовке `X-User-Id` в другие сервисы. Это централизует логику аутентификации.
3.  **Реализована авторизация в сервисах:** `service_orders` использует `X-User-Id` для проверки того, что пользователь имеет доступ только к своим заказам.
4.  **Добавлены механизмы надежности:** В шлюз встроены Circuit Breaker (`opossum`) и Rate Limiter для защиты от перегрузки.
5.  **Улучшена трассировка:** Шлюз генерирует `X-Request-Id` для каждого запроса, что позволяет отслеживать его путь по системе.

## 3. Тестирование и документация

*   **Спецификация API:** Разработана спецификация в формате **OpenAPI 3.0** и сохранена в файле `docs/openapi.yml`. Она детально описывает все доступные эндпоинты, их параметры и ожидаемые ответы.
*   **Ручное тестирование:** Подготовлен файл `test.md`, содержащий набор `curl` команд для пошаговой проверки всей реализованной функциональности: от регистрации до создания и получения заказа.

## 4. Результаты тестирования

Для проверки работоспособности системы были проведены ручные тесты с использованием `curl`, как описано в `test.md`. Ниже приведены результаты ключевых тестов.

### 1. Регистрация пользователя
**Описание:** Создаем нового пользователя. Ожидаем ответ `201 Created` и данные пользователя.
*Команда выполнена успешно.*

![Результат регистрации](assets/test_screenshots/1.png)

### 2. Повторная регистрация
**Описание:** Пытаемся создать пользователя с тем же email. Ожидаем ответ `409 Conflict`.
*Команда выполнена успешно.*

![Результат повторной регистрации](assets/test_screenshots/2.png)

### 3. Вход пользователя (логин)
**Описание:** Используем данные для входа. Ожидаем ответ `200 OK` и JWT токен.
*Команда выполнена успешно, токен получен.*

![Результат входа](assets/test_screenshots/3.png)

### 4. Доступ к защищенному маршруту без токена
**Описание:** Пытаемся получить профиль без токена. Ожидаем ответ `401 Unauthorized`.
*Команда выполнена успешно.*

![Результат без токена](assets/test_screenshots/4.png)

### 5. Доступ к профилю с валидным токеном
**Описание:** Получаем профиль с токеном авторизации. Ожидаем ответ `200 OK` и данные профиля.
*Команда выполнена успешно.*

![Результат с токеном](assets/test_screenshots/5.png)

### 6. Создание заказа
**Описание:** Создаем новый заказ. Ожидаем ответ `201 Created` и данные заказа.
*Команда выполнена успешно.*

![Результат создания заказа](assets/test_screenshots/6.png)

### 7. Получение списка заказов
**Описание:** Получаем все заказы текущего пользователя. Ожидаем `200 OK` и массив с одним заказом.
*Команда выполнена успешно.*

![Результат получения списка заказов](assets/test_screenshots/7.png)

### 8. Получение конкретного заказа
**Описание:** Получаем созданный заказ по его ID. Ожидаем `200 OK` и данные заказа.
*Команда выполнена успешно.*

![Результат получения заказа по ID](assets/test_screenshots/8.png)
